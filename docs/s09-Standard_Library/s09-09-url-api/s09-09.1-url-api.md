# Работа с URL в JavaScript

В веб-разработке на JavaScript часто возникает необходимость работы с URL-адресами. Класс `URL` предоставляет мощный инструментарий для парсинга, модификации и корректного управления различными компонентами URL, включая правильное экранирование специальных символов.

Хотя `URL` не является частью стандарта ECMAScript, он поддерживается во всех современных браузерах (кроме Internet Explorer) и в Node.js, а его спецификация стандартизирована на https://url.spec.whatwg.org.

## Создание и парсинг URL объектов

### Конструктор URL()

Создание объекта URL происходит через конструктор `new URL()`:

```javascript
// Абсолютный URL
let url = new URL("https://example.com:8000/path/name?q=term#fragment");

// Относительный URL с указанием базового адреса
let baseUrl = "https://example.com";
let relativeUrl = new URL("/api/data", baseUrl);
```

### Свойства URL объекта

После создания объекта URL вы можете получить доступ к его различным компонентам:

```javascript
let url = new URL("https://example.com:8000/path/name?q=term#fragment");

url.href        // Полный URL: "https://example.com:8000/path/name?q=term#fragment"
url.origin      // Источник: "https://example.com:8000"
url.protocol    // Протокол: "https:"
url.host        // Хост с портом: "example.com:8000"
url.hostname    // Имя хоста: "example.com"
url.port        // Порт: "8000"
url.pathname    // Путь: "/path/name"
url.search      // Строка запроса: "?q=term"
url.hash        // Фрагмент: "#fragment"
```

### Работа с аутентификацией

URL может содержать данные аутентификации:

```javascript
let url = new URL("ftp://admin:1337!@ftp.example.com/");

url.username    // "admin"
url.password    // "1337!"
url.origin      // "ftp://ftp.example.com" (только протокол и хост)
```

Важно отметить, что свойство `origin` только для чтения и представляет собой комбинацию протокола и хоста.

## Модификация URL

Большинство свойств URL объекта доступны для записи:

```javascript
let url = new URL("https://example.com");

// Изменяем различные компоненты URL
url.pathname = "api/search";    // Добавляем путь
url.search = "q=test";          // Добавляем параметры запроса

url.toString() // "https://example.com/api/search?q=test"
```

## Автоматическое экранирование символов

Одно из ключевых преимуществ класса URL — автоматическое正确处理 специальных символов:

```javascript
let url = new URL("https://example.com");

url.pathname = "path with spaces";  // Пробелы будут экранированы
url.search = "q=foo#bar";           // Символ # будет экранирован

url.pathname  // "/path%20with%20spaces"
url.search    // "?q=foo%23bar"
url.href      // "https://example.com/path%20with%20spaces?q=foo%23bar"
```

Свойство `href` является особым: его чтение эквивалентно вызову `toString()`, а запись запускает парсер заново.

## Работа с параметрами запроса

### Свойства search и searchParams

Для работы с query-параметрами доступны два свойства:

- `search` — вся строка запроса (включая `?`)
- `searchParams` — объект `URLSearchParams` для работы с отдельными параметрами

```javascript
let url = new URL("https://example.com/search");

// Изначально строка запроса пуста
url.search // => ""

// Добавляем параметры через searchParams
url.searchParams.append("q", "term");
url.search // => "?q=term"

// Модифицируем параметр
url.searchParams.set("q", "x");
url.search // => "?q=x"

// Получаем значения параметров
url.searchParams.get("q")    // "x"
url.searchParams.has("q")    // true
url.searchParams.has("p")    // false
```

### Расширенные операции с параметрами

```javascript
let url = new URL("https://example.com/search");

// Добавляем несколько параметров
url.searchParams.append("q", "term");
url.searchParams.append("opts", "1");
url.search // => "?q=term&opts=1"

// Добавляем второе значение для того же параметра
url.searchParams.append("opts", "&");
url.search // => "?q=term&opts=1&opts=%26"

// Получаем значения
url.searchParams.get("opts")     // "1" (первое значение)
url.searchParams.getAll("opts")  // ["1", "&"] (все значения)

// Сортировка параметров
url.searchParams.sort();
url.search // => "?opts=1&opts=%26&q=term"

// Итерация по параметрам
for (let [key, value] of url.searchParams) {
    console.log(key, value);
}

// Удаление параметра
url.searchParams.delete("opts");
url.search // => "?q=term"
```

### Создание параметров через URLSearchParams

Вы можете создать объект параметров отдельно:

```javascript
let url = new URL("http://example.com");
let params = new URLSearchParams();

params.append("q", "term");
params.append("opts", "exact");
params.toString() // "q=term&opts=exact"

url.search = params;
url.href // "http://example.com/?q=term&opts=exact"
```

## Устаревшие функции работы с URL

### Функции escape() и unescape()

Глобальные функции `escape()` и `unescape()` устарели и не должны использоваться в новом коде.

### encodeURI() и decodeURI()

```javascript
// Кодирует весь URL, но не экранирует разделители /, ?, #
encodeURI("https://example.com/path with spaces") 
// "https://example.com/path%20with%20spaces"

// Декодирует закодированный URL
decodeURI("https://example.com/path%20with%20spaces")
// "https://example.com/path with spaces"
```

### encodeURIComponent() и decodeURIComponent()

```javascript
// Кодирует отдельные компоненты URL, включая разделители
encodeURIComponent("path with spaces/search?q=test")
// "path%20with%20spaces%2Fsearch%3Fq%3Dtest"

// Декодирует компоненты
decodeURIComponent("path%20with%20spaces%2Fsearch%3Fq%3Dtest")
// "path with spaces/search?q=test"
```

**Важное замечание**: `encodeURIComponent()` преобразует пробелы в `%20`, хотя в query-параметрах рекомендуется использовать `+`. Также он экранирует символы `/` в путях, что обычно не требуется.

## Рекомендации

1. **Всегда используйте класс URL** для работы с URL в современном JavaScript
2. **Избегайте устаревших функций** `escape()`, `unescape()`, `encodeURI()`, `decodeURI()`
3. **Для query-параметров** используйте `URLSearchParams` вместо ручного форматирования строк
4. **Помните об автоматическом экранировании** — класс URL правильно обрабатывает специальные символы

## Заключение

Класс `URL` и связанный с ним `URLSearchParams` предоставляют современный, безопасный и удобный API для работы с URL-адресами в JavaScript. Они правильно обрабатывают кодирование символов, упрощают манипуляции с различными компонентами URL и обеспечивают совместимость между браузером и серверной средой выполнения.

Использование этих API вместо устаревших функций гарантирует корректную работу вашего кода с различными URL-адресами и избежание распространенных ошибок, связанных с неправильным экранированием специальных символов.
